# Zip List

## Zip List

如果没有特殊说明，本章节全部采用 [Little Endian](https://en.wikipedia.org/wiki/Endianness#Little-endian) 存储数据。

```text
 uint32_t  uint32_t uint16_t                              uint8_t
+---------+--------+-------+-------+-------+-----+-------+-------+
| zlbytes | zltail | zllen | entry | entry | ... | entry | zlend |
+---------+--------+-------+-------+-------+-----+-------+-------+
   |          |        |                                     |
   |          |        |                                     +---> zip list 结尾，取值 0xFF(255)
   |          |        |
   |          |        +----> entries 数量
   |          |
   |          +----> 最后一个 entry 在 zip list 中的偏移量
   |
   +----> zip list 总长度 (bytes)，含自身长度 (4 Bytes)
```

## Entry

```text
+---------+----------+--------+------------+
| prevlen | encoding | length | entry-data |
+---------+----------+--------+------------+
     |         |          |
     |         |          +----> 可能与 encoding 在同一个 Byte 中 
     |         |
     |         +----> 含长度所占字节信息
     |
     +----> 前一个 entry 占用的空间，从后向前遍历时更加快速
```

或

```text
+---------+----------+
| prevlen | encoding |
+---------+----------+
```

### prevlen 编码方式

- prevlen 小于 254

```text
  uint8_t
+---------+----------+------------+
| 0 ~ 253 | encoding | entry-data |
+---------+----------+------------+
```

- 大于等于 254

```text
 uint8_t   uint32_t
+--------+---------+-----------+
|  0xFE  | prevlen |    ...    |
+--------+---------+-----------+
```

### encoding

#### string

在 zip list 中表示的字符串不含 '\0' 结尾符。

- <= 63 字节

```C
  7   6   5   4   3   2   1   0
+---+---+---+---+---+---+---+---+
| 0 | 0 |   |   |   |   |   |   |
+---+---+---+---+---+---+---+---+
        |<--     length      -->|

由于 length 只有 6 bits，所以能表示的最大长度为 2 ^ 6 - 1 = 63 字节
```

- \> 63 且 <= 16383

14-bits 长度使用 [Big Endian](https://en.wikipedia.org/wiki/Endianness#Big-endian)

```text
  7   6   5   4   3   2   1   0   7   6   5   4   3   2   1   0
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
| 0 | 1 |   |   |   |   |   |   |   |   |   |   |   |   |   |   |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
        |<--------                length               -------->|

总长度为 2 ^ 14 - 1 = 16383
```

- \> 16383 且 <= 2 ^ 32 -1

32-bits 长度使用 [Big Endian](https://en.wikipedia.org/wiki/Endianness#Big-endian)

```text
  7   6   5   4   3   2   1   0   
+---+---+---+---+---+---+---+---+--------------------------------+
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |                                |
+---+---+---+---+---+---+---+---+--------------------------------+
                                |<----    4 Bytes length    ---->|
```

#### integer

- int16_t

```text
  7   6   5   4   3   2   1   0
+---+---+---+---+---+---+---+---+----------------------------------------+
| 1 | 1 | 0 | 0 |   |   |   |   |                                        |
+---+---+---+---+---+---+---+---+----------------------------------------+
                                |<----        2 Bytes Integer       ---->|
```

- int32_t

```text
  7   6   5   4   3   2   1   0
+---+---+---+---+---+---+---+---+----------------------------------------+
| 1 | 1 | 0 | 1 |   |   |   |   |                                        |
+---+---+---+---+---+---+---+---+----------------------------------------+
                                |<----           4 Bytes            ---->|
```

- int64_t

```text
  7   6   5   4   3   2   1   0
+---+---+---+---+---+---+---+---+----------------------------------------+
| 1 | 1 | 1 | 0 |   |   |   |   |                                        |
+---+---+---+---+---+---+---+---+----------------------------------------+
                                |<----            8 Bytes           ---->|
```

- 24 bits signed

```text
  7   6   5   4   3   2   1   0
+---+---+---+---+---+---+---+---+----------------------------------------+
| 1 | 1 | 1 | 1 |   |   |   |   |                                        |
+---+---+---+---+---+---+---+---+----------------------------------------+
                                |<----            3 Bytes           ---->|
```

- 8 bits signed

```text
  7   6   5   4   3   2   1   0
+---+---+---+---+---+---+---+---+----------------------------------------+
| 1 | 1 | 1 | 1 | 1 | 1 | 1 |   |                                        |
+---+---+---+---+---+---+---+---+----------------------------------------+
                                |<----            1 Byte            ---->|
```

- 4 bits integer

```text
  7   6   5   4   3   2   1   0
+---+---+---+---+---+---+---+---+
| 1 | 1 | 1 | 1 | x | x | x | x |
+---+---+---+---+---+---+---+---+
                |<------+------>|
                        |
                        +--> xxxx 介于 (0000,1101] 时，实际编码值代表 0 ~ 12；计算方式为 xxxx - 1
```

#### 实例分析

```text
[0f 00 00 00] [0c 00 00 00] [02 00] [00 f3] [02 f6] [ff]
       |             |          |       |       |     |
     zlbytes       zltail    entries   "2"     "5"   end
```

## References

- [Endianness](https://en.wikipedia.org/wiki/Endianness)
